{"version":3,"sources":["../../src/config/processConfig.js"],"names":["each","isObjectLike","get","isFunction","isUndefined","isString","isEmpty","defaults","require","fs","processObj","obj","data","depthPath","depth","join","config","context","value","key","push","pop","resolve","tmpl","path","params","split","startsWith","substr","x","missing","length","map","test","newV","slice","includes","more","replace","match","processConfig","options","process","argv","cwd","env","now","Date","readFile","enc","readFileSync","trim","toString","Error","getEnv","cc","toLowerCase","toUpperCase","maxRun","i","module","exports"],"mappings":"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","sourcesContent":["// From https://github.com/electrode-io/electrode-confippet/blob/master/lib/process-config.js\n'use strict'\n\nconst {\n\teach,\n\tisObjectLike,\n\tget,\n\tisFunction,\n\tisUndefined,\n\tisString,\n\tisEmpty,\n\tdefaults,\n} = require('lodash')\nconst fs = require('fs')\n\nfunction processObj(obj, data) {\n\tconst depthPath = data.depth.join('.')\n\tconst {config, context} = data\n\n\teach(obj, (value, key) => {\n\t\tif (isObjectLike(value)) {\n\t\t\tdata.depth.push(key)\n\t\t\tprocessObj(value, data)\n\t\t\tdata.depth.pop()\n\t\t\treturn\n\t\t}\n\n\t\tconst resolve = tmpl => {\n\t\t\tconst [path, ...params] = tmpl.split(':')\n\n\t\t\tif (path.startsWith('-')) {\n\t\t\t\t// plain string\n\t\t\t\treturn path.substr(1)\n\t\t\t}\n\n\t\t\tconst x = get(context, path)\n\n\t\t\tif (isFunction(x))\n\t\t\t\treturn x({\n\t\t\t\t\tcontext,\n\t\t\t\t\tconfig,\n\t\t\t\t\tobj,\n\t\t\t\t\tkey,\n\t\t\t\t\tvalue,\n\t\t\t\t\ttmpl,\n\t\t\t\t\tparams,\n\t\t\t\t\tdepthPath,\n\t\t\t\t\tresolve,\n\t\t\t\t})\n\t\t\tif (isUndefined(x)) {\n\t\t\t\tdata.missing.push({path: `${depthPath}.${key}`, value, tmpl})\n\t\t\t\treturn ''\n\t\t\t}\n\t\t\treturn params.length ? `${x}${params.map(x => resolve(x)).join('')}` : x\n\t\t}\n\n\t\tif (isString(value)) {\n\t\t\tif (/^\\{\\{[^}]+}}$/.test(value)) {\n\t\t\t\tconst newV = resolve(value.slice(2, -2))\n\t\t\t\tobj[key] = newV\n\t\t\t\tif (typeof newV === 'string' && newV.includes('{{')) {\n\t\t\t\t\tdata.more++\n\t\t\t\t}\n\t\t\t} else if (value.includes('{{')) {\n\t\t\t\tobj[key] = value.replace(/\\{\\{([^}]+)}}/g, (match, tmpl) => {\n\t\t\t\t\tconst newV = resolve(tmpl)\n\t\t\t\t\tif (typeof newV === 'string' && newV.includes('{{')) {\n\t\t\t\t\t\tdata.more++\n\t\t\t\t\t}\n\t\t\t\t\treturn newV\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t})\n}\n\nfunction processConfig(config, options) {\n\tif (isEmpty(config)) {\n\t\treturn []\n\t}\n\n\toptions = options || {}\n\n\tconst context = {\n\t\tconfig,\n\t\tprocess,\n\t\targv: process.argv,\n\t\tcwd: process.cwd(),\n\t\tenv: process.env,\n\t\tnow: Date.now,\n\t\treadFile: ({params}) => {\n\t\t\tif (params[0]) {\n\t\t\t\tconst enc = params[1] || 'utf8'\n\t\t\t\treturn fs.readFileSync(params[0].trim()).toString(enc.trim())\n\t\t\t}\n\t\t\tthrow new Error('config file readFile template missing filename')\n\t\t},\n\t\tgetEnv: ({params}) => {\n\t\t\tif (params[0]) {\n\t\t\t\tlet value = process.env[params[0]]\n\t\t\t\tif (value) {\n\t\t\t\t\tconst cc = params[1]\n\t\t\t\t\tif (cc === 'lowerCase' || cc === 'LC') {\n\t\t\t\t\t\tvalue = value.toLowerCase()\n\t\t\t\t\t} else if (cc === 'upperCase' || cc === 'UC') {\n\t\t\t\t\t\tvalue = value.toUpperCase()\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn value\n\t\t\t}\n\t\t},\n\t}\n\n\tdefaults(context, options.context)\n\n\tconst data = {\n\t\tconfig,\n\t\tcontext,\n\t\toptions,\n\t\tmore: 1,\n\t\tmissing: [],\n\t\tdepth: ['config'],\n\t}\n\tconst maxRun = 20\n\n\tfor (let i = 0; data.more > 0; i++) {\n\t\tif (i >= maxRun) {\n\t\t\tthrow new Error(`Unable to process config after ${maxRun} passes.`)\n\t\t}\n\t\tdata.more = 0\n\t\tprocessObj(config, data)\n\t}\n\n\treturn data.missing\n}\n\nmodule.exports = processConfig\n"],"file":"processConfig.js"}