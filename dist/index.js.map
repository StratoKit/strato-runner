{"version":3,"sources":["../src/index.js"],"names":["dbg","plugins","getPluginFromRegistry","entry","plugin","registry","TypeError","then","name","process","env","NODE_ENV","version","config","requires","load","start","stop","configured","loaded","started","rest","keys","Object","length","join","configureRecurse","configuring","_$","defaults","dep","configure","loadRecurse","startRecurse","stopRecurse","revReqs","reverse","Error","stratokit"],"mappings":"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","sourcesContent":["/* eslint-disable no-await-in-loop */\nimport debug from 'debug'\nimport config from './config'\nimport registry from './registry'\nimport finalize from './config/finalize'\n\nconst dbg = debug('stratokit')\n\nconst plugins = {}\n\nconst getPluginFromRegistry = async entry => {\n\tlet plugin = registry[entry]\n\tif (!plugin) {\n\t\tthrow new TypeError(`no plugin with the name \"${entry}\" is registered`)\n\t}\n\tif (plugin.then) {\n\t\tplugin = await plugin\n\t\tif (!plugin || typeof plugin.name !== 'string') {\n\t\t\tthrow new TypeError(\n\t\t\t\t`Promise for plugin \"${entry}\" did not yield a plugin`\n\t\t\t)\n\t\t}\n\t\tregistry[entry] = plugin\n\t}\n\tif (process.env.NODE_ENV !== 'production') {\n\t\tconst {\n\t\t\tname,\n\t\t\tversion,\n\t\t\tconfig,\n\t\t\trequires,\n\t\t\tload,\n\t\t\tstart,\n\t\t\tstop,\n\t\t\tconfigured,\n\t\t\tloaded,\n\t\t\tstarted,\n\t\t\t...rest\n\t\t} = plugin\n\t\tconst keys = Object.keys(rest)\n\t\tif (keys.length) {\n\t\t\tthrow new TypeError(\n\t\t\t\t`Plugin ${entry} has these unknown keys: ${keys.join(' ')}`\n\t\t\t)\n\t\t}\n\t}\n\treturn plugin\n}\n\nconst configureRecurse = async plugin => {\n\tif (plugin.configured) return\n\n\tif (plugin.configuring)\n\t\tthrow new TypeError(`circular dependency configuring \"${plugin.name}`)\n\n\tplugin.configuring = true\n\n\t// Height-first, so the plugin loaded first gets to set the value\n\tif (plugin.config) config._$.defaults(plugin.config)\n\n\tif (plugins[plugin.name])\n\t\tthrow new TypeError(\n\t\t\t`naming conflict, there can only be one plugin named \"${plugin.name}`\n\t\t)\n\n\tplugins[plugin.name] = plugin\n\n\t// TODO getRequires(plugin) that can call a function with the config\n\tconst {requires = []} = plugin\n\tfor (const name of requires) {\n\t\tconst dep = await getPluginFromRegistry(name)\n\t\tawait configureRecurse(dep)\n\t}\n\n\tdelete plugin.configuring\n\tplugin.configured = true\n}\n\nconst configure = async plugin => {\n\tawait configureRecurse(plugin)\n\tfinalize(config)\n}\n\nconst loadRecurse = async plugin => {\n\tif (plugin.loaded) return\n\n\tconst {requires = []} = plugin\n\tfor (const name of requires) {\n\t\tawait loadRecurse(plugins[name])\n\t}\n\n\tif (plugin.load) {\n\t\tdbg(`loading plugin ${plugin.name}`)\n\t\tawait plugin.load({config, plugin, plugins})\n\t}\n\n\tplugin.loaded = true\n}\n\nconst startRecurse = async plugin => {\n\tif (plugin.started) return\n\n\tconst {requires = []} = plugin\n\tfor (const name of requires) {\n\t\tawait startRecurse(plugins[name])\n\t}\n\n\tif (plugin.start) {\n\t\tdbg(`starting plugin ${plugin.name}`)\n\t\tawait plugin.start({config, plugin, plugins})\n\t}\n\tplugin.started = true\n}\n\nconst load = async plugin => {\n\tawait configure(plugin)\n\tawait loadRecurse(plugin)\n\treturn plugin\n}\n\nconst start = async entry => {\n\tconst plugin = await getPluginFromRegistry(entry)\n\tawait load(plugin)\n\tawait startRecurse(plugin)\n}\n\nconst stopRecurse = async plugin => {\n\tif (!plugin.started) return\n\n\tif (plugin.stop) {\n\t\tdbg(`stopping plugin ${plugin.name}`)\n\t\tawait plugin.stop({config, plugin})\n\t}\n\tdelete plugin.started\n\n\tconst {requires = []} = plugin\n\tconst revReqs = [...requires].reverse()\n\tfor (const name of revReqs) {\n\t\tawait stopRecurse(plugins[name])\n\t}\n}\n\nconst stop = async entry => {\n\tconst plugin = plugins[entry]\n\tif (!plugin) {\n\t\tthrow new Error(`plugin ${entry} was not found/started`)\n\t}\n\tawait stopRecurse(plugin)\n}\n\nconst stratokit = {\n\tconfig,\n\tplugins,\n\tregistry,\n\tconfigure,\n\tload,\n\tstart,\n\tstop,\n}\n\nexport default stratokit\n"],"file":"index.js"}